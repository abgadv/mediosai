
import React, { useState, useMemo, useContext, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useData } from '../../contexts/DataContext';
import TiltCard from '../../components/TiltCard';
import { DashboardUIContext } from '../../contexts/DashboardUIContext';
import { exportToExcel } from '../../utils/exportHelper';
import { Transaction } from '../../types';
import { formatDate } from '../../utils/formatters';
import { 
  TrendingUp, TrendingDown, DollarSign, RefreshCw, FileDown, 
  Edit2, Trash2, XCircle 
} from 'lucide-react';

const AccountantView: React.FC = () => {
    const { appointments, transactions, addTransaction, updateTransaction, deleteTransaction } = useData();
    // Use systemUser instead of user which doesn't exist on AuthContextType
    const { systemUser } = useAuth();
    const { setHeaderHidden } = useContext(DashboardUIContext);
    const today = new Date().toISOString().split('T')[0];
    const [dateFrom, setDateFrom] = useState('');
    const [dateTo, setDateTo] = useState('');
    const [typeFilter, setTypeFilter] = useState<'All' | 'Income' | 'Expense'>('All');
    const [showModal, setShowModal] = useState(false);
    const [editingTx, setEditingTx] = useState<Partial<Transaction> | null>(null);
    const [txForm, setTxForm] = useState({ date: today, description: '', type: 'income' as 'income' | 'expense', amount: '' });
    
    useEffect(() => {
        setHeaderHidden(showModal);
    }, [showModal, setHeaderHidden]);

    const canAdd = systemUser?.role === 'admin' || systemUser?.permissions?.accountant?.actions?.add_transaction;

    const combinedData = useMemo(() => { 
        const paidAppts = appointments.filter(a => a.paid > 0).map(a => ({ id: a.id, date: a.date, description: `${a.name} - ${a.notes || 'No notes'}`, type: 'income' as const, amount: a.paid, isSystem: true })); 
        const all = [...paidAppts, ...transactions.map(t => ({ ...t, isSystem: false }))]; 
        return all.filter(t => { 
            const dateMatch = (!dateFrom || t.date >= dateFrom) && (!dateTo || t.date <= dateTo); 
            const typeMatch = typeFilter === 'All' || (typeFilter === 'Income' && t.type === 'income') || (typeFilter === 'Expense' && t.type === 'expense'); 
            return dateMatch && typeMatch; 
        }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); 
    }, [appointments, transactions, dateFrom, dateTo, typeFilter]);

    const totals = useMemo(() => { const income = combinedData.filter(t => t.type === 'income').reduce((sum, t) => sum + Number(t.amount), 0); const expense = combinedData.filter(t => t.type === 'expense').reduce((sum, t) => sum + Number(t.amount), 0); return { income, expense, net: income - expense }; }, [combinedData]);
    const handleTxSubmit = async (e: React.FormEvent) => { e.preventDefault(); if(txForm.description && txForm.amount) { const amount = Number(txForm.amount); if(editingTx && editingTx.id) { await updateTransaction(editingTx.id, { date: txForm.date, description: txForm.description, type: txForm.type, amount: amount }); } else { await addTransaction({ date: txForm.date, description: txForm.description, type: txForm.type, amount: amount }); } setShowModal(false); setEditingTx(null); setTxForm({ date: today, description: '', type: 'income', amount: '' }); } };
    const openEdit = (tx: any) => { setEditingTx(tx); setTxForm({ date: tx.date, description: tx.description, type: tx.type, amount: tx.amount.toString() }); setShowModal(true); };
    const handleDownloadExcel = () => { const dataToExport = combinedData.map(t => ({ Date: formatDate(t.date), Description: t.description, Type: t.type, Amount: t.amount, EntryType: (t as any).isSystem ? 'System' : 'Manual' })); exportToExcel(dataToExport, `Accountant_Report_${today}`); };

    return (
        <div className="space-y-6 animate-fade-in">
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6"> <TiltCard glowColor="green" className="p-6 flex items-center justify-between border-green-500/20 group"> <div> <p className="text-gray-400 text-xs font-bold uppercase tracking-wider group-hover:text-green-400 transition-colors">Total Income</p> <h3 className="text-4xl font-black mt-2 text-green-400 drop-shadow-[0_0_10px_rgba(34,197,94,0.3)] group-hover:scale-105 transition-transform origin-left">${totals.income.toFixed(2)}</h3> </div> <div className="w-14 h-14 rounded-2xl bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20 shadow-[0_0_20px_-5px_rgba(34,197,94,0.3)]"> <TrendingUp size={28} /> </div> </TiltCard> <TiltCard glowColor="red" className="p-6 flex items-center justify-between border-red-500/20 group"> <div> <p className="text-gray-400 text-xs font-bold uppercase tracking-wider group-hover:text-red-400 transition-colors">Total Outcome</p> <h3 className="text-4xl font-black mt-2 text-red-400 drop-shadow-[0_0_10px_rgba(239,68,68,0.3)] group-hover:scale-105 transition-transform origin-left">${totals.expense.toFixed(2)}</h3> </div> <div className="w-14 h-14 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20 shadow-[0_0_20px_-5px_rgba(34,197,94,0.3)]"> <TrendingDown size={28} /> </div> </TiltCard> <TiltCard className="p-6 flex items-center justify-between border-white/10 group" glowColor="cyan"> <div> <p className="text-gray-400 text-xs font-bold uppercase tracking-wider group-hover:text-white transition-colors">Net Profit</p> <h3 className={`text-4xl font-black mt-2 ${totals.net >= 0 ? 'text-neon-blue drop-shadow-[0_0_10px_rgba(0,243,255,0.4)]' : 'text-orange-500 drop-shadow-[0_0_10px_rgba(249,115,22,0.4)]'} group-hover:scale-105 transition-transform origin-left`}>${totals.net.toFixed(2)}</h3> </div> <div className="w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center text-white border border-white/10 shadow-lg"> <DollarSign size={28} /> </div> </TiltCard> </div> <TiltCard className="p-0 border-white/5" glowColor="cyan"> <div className="flex flex-wrap items-end gap-4 p-6 bg-black/20 border-b border-white/5"> <div className="flex flex-col gap-1.5"> <label className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Date From</label> <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-neon-blue outline-none transition-colors" /> </div> <div className="flex flex-col gap-1.5"> <label className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Date To</label> <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-neon-blue outline-none transition-colors" /> </div> <div className="flex flex-col gap-1.5 min-w-[120px]"> <label className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Type</label> <select value={typeFilter} onChange={e => setTypeFilter(e.target.value as any)} className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-neon-blue outline-none transition-colors appearance-none"> <option value="All">All Transactions</option> <option value="Income">Income Only</option> <option value="Expense">Expense Only</option> </select> </div> <button onClick={() => { setDateFrom(''); setDateTo(''); setTypeFilter('All'); }} className="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white rounded-lg text-sm font-bold flex items-center gap-2 transition-colors border border-white/5"> <RefreshCw size={16} /> </button> <button onClick={handleDownloadExcel} className="px-5 py-2.5 bg-green-600/10 text-green-400 border border-green-500/30 rounded-xl hover:bg-green-600/20 text-xs font-bold uppercase tracking-wide flex items-center gap-2 transition-all"> <FileDown size={16} /> Export </button> <div className="flex-1 text-right"> {canAdd && <button onClick={() => { setEditingTx(null); setTxForm({ date: today, description: '', type: 'income', amount: '' }); setShowModal(true); }} className="px-6 py-2.5 bg-neon-blue text-black font-bold rounded-xl shadow-[0_0_15px_rgba(0,243,255,0.4)] hover:bg-cyan-400 transition-all hover:scale-105 active:scale-95 text-xs uppercase tracking-wide"> + Add Entry </button>} </div> </div> <div className="overflow-x-auto"> <table className="w-full text-left text-sm text-gray-400"> <thead className="bg-white/5 text-gray-300 uppercase font-bold text-xs tracking-wider"> <tr> <th className="p-4">Date</th> <th className="p-4">Description</th> <th className="p-4">Type</th> <th className="p-4 text-right">Amount</th> <th className="p-4 text-center">Action</th> </tr> </thead> <tbody className="divide-y divide-white/5"> {combinedData.map((tx, idx) => ( <tr key={tx.id || idx} className="hover:bg-white/5 transition-colors group"> <td className="p-4 font-mono">{formatDate(tx.date)}</td> <td className="p-4 font-medium text-white group-hover:text-neon-blue transition-colors">{tx.description}</td> <td className="p-4"> <span className={`px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border ${tx.type === 'income' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}> {tx.type === 'income' ? 'IN' : 'OUT'} </span> </td> <td className={`p-4 text-right font-mono font-bold text-lg ${tx.type === 'income' ? 'text-green-400 drop-shadow-[0_0_5px_rgba(34,197,94,0.3)]' : 'text-red-400 drop-shadow-[0_0_5px_rgba(239,68,68,0.3)]'}`}> {tx.type === 'income' ? '+' : '-'}${Number(tx.amount).toFixed(2)} </td> <td className="p-4 text-center"> {!tx.isSystem ? ( <div className="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity"> <button onClick={() => openEdit(tx)} className="p-2 text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg transition-colors"><Edit2 size={16} /></button> <button onClick={() => deleteTransaction(tx.id)} className="p-2 text-red-400 hover:text-white bg-red-500/10 hover:bg-red-500/30 rounded-lg transition-colors"><Trash2 size={16} /></button> </div> ) : ( <span className="text-[10px] text-gray-600 italic bg-white/5 px-2 py-0.5 rounded">System</span> )} </td> </tr> ))} {combinedData.length === 0 && ( <tr><td colSpan={5} className="p-12 text-center text-gray-500 italic">No transactions found.</td></tr> )} </tbody> </table> </div> </TiltCard> {showModal && ( <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-fade-in"> <div className="w-full max-w-md glass-panel rounded-2xl p-8 border border-neon-blue/20 shadow-[0_0_50px_-10px_rgba(0,243,255,0.2)] animate-slide-up"> <div className="flex justify-between items-center mb-8 pb-4 border-b border-white/10"> <h3 className="text-2xl font-bold text-white tracking-tight">{editingTx ? 'Edit Transaction' : 'Add New Transaction'}</h3> <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-white bg-white/5 p-2 rounded-full hover:bg-white/10 transition-colors"><XCircle /></button> </div> <form onSubmit={handleTxSubmit} className="space-y-5"> <div> <label className="block text-xs text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Date</label> <input type="date" required value={txForm.date} onChange={e => setTxForm({...txForm, date: e.target.value})} className="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white outline-none focus:border-neon-blue focus:bg-black/60 focus:shadow-[0_0_15px_-5px_rgba(0,243,255,0.2)] transition-all" /> </div> <div> <label className="block text-xs text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Description (Name & Notes)</label> <input type="text" required placeholder="e.g. Purchase Office Supplies" value={txForm.description} onChange={e => setTxForm({...txForm, description: e.target.value})} className="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white outline-none focus:border-neon-blue focus:bg-black/60 focus:shadow-[0_0_15px_-5px_rgba(0,243,255,0.2)] transition-all placeholder-gray-600" /> </div> <div className="grid grid-cols-2 gap-5"> <div> <label className="block text-xs text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Type</label> <select value={txForm.type} onChange={e => setTxForm({...txForm, type: e.target.value as any})} className="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white outline-none focus:border-neon-blue focus:bg-black/60 focus:shadow-[0_0_15px_-5px_rgba(0,243,255,0.2)] transition-all appearance-none cursor-pointer"> <option value="income" className="bg-gray-900">Income</option> <option value="expense" className="bg-gray-900">Expense</option> </select> </div> <div> <label className="block text-xs text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Amount ($)</label> <input type="number" required placeholder="0.00" value={txForm.amount} onChange={e => setTxForm({...txForm, amount: e.target.value})} className="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white outline-none focus:border-neon-blue focus:bg-black/60 focus:shadow-[0_0_15px_-5px_rgba(0,243,255,0.2)] transition-all placeholder-gray-600" /> </div> </div> <button type="submit" className="w-full py-4 mt-4 bg-gradient-to-r from-neon-blue to-cyan-600 rounded-xl text-black font-extrabold text-lg hover:opacity-90 transition-all shadow-[0_0_20px_rgba(0,243,255,0.3)] hover:shadow-[0_0_30px_rgba(0,243,255,0.5)] transform hover:-translate-y-1"> {editingTx ? 'Update Transaction' : 'Save Transaction'} </button> </form> </div> </div> )}
        </div>
    );
};

export default AccountantView;
